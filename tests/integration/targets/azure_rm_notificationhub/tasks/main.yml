---
- name: Create random notification hub and namespace
  ansible.builtin.set_fact:
    namespace_name: test{{ resource_group | hash('md5') | truncate(16, True, '') + (65535 | random | string) }}
    name_rpfx: test{{ resource_group | hash('md5') | truncate(16, True, '') + (65535 | random | string) }}

- name: Create Notification Hub Namespace (check mode)
  check_mode: true
  register: results
  azure.azcollection.azure_rm_notificationhub:
    location: eastus2
    namespace_name: "{{ namespace_name }}"
    resource_group: "{{ resource_group }}"
    sku: free

- name: Assert the notification hub check mode
  ansible.builtin.assert:
    that: results.changed

- name: Create Notification Hub  (check mode)
  check_mode: true
  register: results
  azure.azcollection.azure_rm_notificationhub:
    location: eastus2
    namespace_name: "{{ namespace_name }}"
    name: "{{ name_rpfx }}"
    resource_group: "{{ resource_group }}"
    sku: free

- name: Assert the notfication hub check mode
  ansible.builtin.assert:
    that: results.changed

- name: Create Namespace Hub
  register: results
  azure.azcollection.azure_rm_notificationhub:
    location: eastus2
    namespace_name: "{{ namespace_name }}"
    resource_group: "{{ resource_group }}"
    sku: free

- name: Assert the notification hub created
  ansible.builtin.assert:
    that: results.changed

- name: Create Notification Hub
  register: results
  azure.azcollection.azure_rm_notificationhub:
    location: eastus2
    namespace_name: "{{ namespace_name }}"
    name: "{{ name_rpfx }}"
    resource_group: "{{ resource_group }}"
    sku: free

- name: Assert the notification hub created
  ansible.builtin.assert:
    that: results.changed

- name: Update Namespace
  register: results
  azure.azcollection.azure_rm_notificationhub:
    location: eastus2
    namespace_name: "{{ namespace_name }}"
    resource_group: "{{ resource_group }}"
    tags:
      test: modified

- name: Assert the namespace updated
  ansible.builtin.assert:
    that:
      - results.changed
      - results.state.tags.test == 'modified'

- name: Update Notification Hub
  register: results
  azure.azcollection.azure_rm_notificationhub:
    location: eastus2
    namespace_name: "{{ namespace_name }}"
    name: "{{ name_rpfx }}"
    resource_group: "{{ resource_group }}"
    tags:
      test: modified

- name: Assert the notification hub updated
  ansible.builtin.assert:
    that:
      - results.changed
      - results.state.tags.test == 'modified'

- name: Retrieve Namespace
  register: results
  azure.azcollection.azure_rm_notificationhub_info:
    namespace_name: "{{ namespace_name }}"
    resource_group: "{{ resource_group }}"

- name: Assert that facts module returned result
  ansible.builtin.assert:
    that:
      - results.namespace[0].tags.test == 'modified'

- name: Test idempotent
  register: results
  azure.azcollection.azure_rm_notificationhub:
    namespace_name: "{{ namespace_name }}"
    resource_group: "{{ resource_group }}"

- name: Assert the notification hub check mode
  ansible.builtin.assert:
    that:
      - not results.changed

#
# azure_rm_ddos_notification hub and namspace cleanup
#

- name: Delete Namespace
  azure.azcollection.azure_rm_notificationhub:
    location: eastus2
    namespace_name: "{{ namespace_name }}"
    resource_group: "{{ resource_group }}"
    state: absent

- name: Pause for 3 minutes to make sure delete successfully
  ansible.builtin.pause:
    minutes: 3
  changed_when: true

- name: Delete Namespace (idempotent)
  register: results
  azure.azcollection.azure_rm_notificationhub:
    location: eastus2
    namespace_name: "{{ namespace_name }}"
    resource_group: "{{ resource_group }}"
    state: absent

- name: Assert the namespace deleted
  ansible.builtin.assert:
    that: not results.changed

- name: Delete Notification Hub
  azure.azcollection.azure_rm_notificationhub:
    location: eastus2
    namespace_name: "{{ namespace_name }}"
    name: "{{ name_rpfx }}"
    resource_group: "{{ resource_group }}"
    state: absent

- name: Pause for 3 minutes to make sure delete successfully
  ansible.builtin.pause:
    minutes: 3
  changed_when: true

- name: Delete Notification Hub (idempotent)
  register: results
  azure.azcollection.azure_rm_notificationhub:
    location: eastus2
    namespace_name: "{{ namespace_name }}"
    name: "{{ name_rpfx }}"
    resource_group: "{{ resource_group }}"
    state: absent

- name: Assert the notificationhub deleted
  ansible.builtin.assert:
    that: not results.changed
