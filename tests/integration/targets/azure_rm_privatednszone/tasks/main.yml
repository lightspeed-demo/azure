---
- name: Create random domain name
  ansible.builtin.set_fact:
    domain_name: "{{ resource_group | hash('md5') | truncate(16, True, '') + (65535 | random | string) }}"

- name: Create a private DNS zone (check mode)
  register: results
  check_mode: true
  azure.azcollection.azure_rm_privatednszone:
    resource_group: "{{ resource_group }}"
    name: "{{ domain_name }}.com"

- name: Assert there is no private dns zone resource
  ansible.builtin.assert:
    that: results.changed

- name: Create a private DNS zone
  register: results
  azure.azcollection.azure_rm_privatednszone:
    resource_group: "{{ resource_group }}"
    name: "{{ domain_name }}.com"

- name: Assert the private dns zone created
  ansible.builtin.assert:
    that: results.changed

- name: Update private DNS zone with tags
  register: results
  azure.azcollection.azure_rm_privatednszone:
    resource_group: "{{ resource_group }}"
    name: "{{ domain_name }}.com"
    tags:
      test: modified

- name: Assert the private dns zone updated
  ansible.builtin.assert:
    that:
      - results.changed
      - results.state.tags.test == 'modified'

- name: Test idempotent
  register: results
  azure.azcollection.azure_rm_privatednszone:
    name: "{{ domain_name }}.com"
    resource_group: "{{ resource_group }}"

- name: Assert idempotent
  ansible.builtin.assert:
    that:
      - not results.changed

- name: Retrieve DNS Zone Facts
  register: zones
  azure.azcollection.azure_rm_privatednszone_info:
    resource_group: "{{ resource_group }}"
    name: "{{ domain_name }}.com"

- name: Assert that facts module returned result
  ansible.builtin.assert:
    that:
      - zones.privatednszones[0].tags.test == 'modified'
      - zones.privatednszones[0].number_of_record_sets == 1

#
# azure_rm_privatednszone cleanup
#

- name: Delete private DNS zone
  azure.azcollection.azure_rm_privatednszone:
    resource_group: "{{ resource_group }}"
    name: "{{ domain_name }}.com"
    state: absent

- name: Delete private DNS zone (idempotent)
  register: results
  azure.azcollection.azure_rm_privatednszone:
    resource_group: "{{ resource_group }}"
    name: "{{ domain_name }}.com"
    state: absent

- name: Assert the private dns zone deleted
  ansible.builtin.assert:
    that: not results.changed
